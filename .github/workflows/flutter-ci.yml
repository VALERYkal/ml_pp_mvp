name: Flutter CI

on:
  push:
    paths-ignore:
      - "README.md"
      - "**/*.md"
      - ".vscode/**"
  pull_request:
    paths-ignore:
      - "README.md"
      - "**/*.md"
      - ".vscode/**"

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Lints & Analyse
    runs-on: [self-hosted, Windows, X64]
    continue-on-error: true
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4

      # Installer jq en bash
      - name: Install jq (Windows via bash)
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already present: $(jq --version)"; exit 0
          fi
          URL="https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
          DST="$RUNNER_TEMP/jq.exe"
          if command -v curl >/dev/null 2>&1; then
            curl -fsSL "$URL" -o "$DST"
          else
            wget -qO "$DST" "$URL"
          fi
          BIN_DIR="$RUNNER_TEMP/jqbin"
          mkdir -p "$BIN_DIR"
          cp "$DST" "$BIN_DIR/jq.exe"
          WIN_BIN_DIR="$(cygpath -w "$BIN_DIR")"
          echo "$WIN_BIN_DIR" >> "$GITHUB_PATH"
          "$BIN_DIR/jq.exe" --version

      - name: Verify jq (bash)
        shell: bash
        run: |
          echo "which jq => $(which jq || true)"
          jq --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Format check (lib + test seulement)
        run: dart format --output=none --set-exit-if-changed lib test

      - name: Dart analyze (lib only)
        run: flutter analyze lib

  test:
    name: Tests unitaires
    runs-on: [self-hosted, Windows, X64]
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4

      - name: Install jq (Windows via bash)
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already present: $(jq --version)"; exit 0
          fi
          URL="https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
          DST="$RUNNER_TEMP/jq.exe"
          if command -v curl >/dev/null 2>&1; then
            curl -fsSL "$URL" -o "$DST"
          else
            wget -qO "$DST" "$URL"
          fi
          BIN_DIR="$RUNNER_TEMP/jqbin"
          mkdir -p "$BIN_DIR"
          cp "$DST" "$BIN_DIR/jq.exe"
          WIN_BIN_DIR="$(cygpath -w "$BIN_DIR")"
          echo "$WIN_BIN_DIR" >> "$GITHUB_PATH"
          "$BIN_DIR/jq.exe" --version

      - name: Verify jq (bash)
        shell: bash
        run: |
          echo "which jq => $(which jq || true)"
          jq --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Run tests (expanded)
        run: flutter test -r expanded --exclude-tags=e2e,integration,needs-refactor

  build_web:
    name: Build Web (smoke compile)
    runs-on: [self-hosted, Windows, X64]
    needs: test
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4

      - name: Install jq (Windows via bash)
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already present: $(jq --version)"; exit 0
          fi
          URL="https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
          DST="$RUNNER_TEMP/jq.exe"
          if command -v curl >/dev/null 2>&1; then
            curl -fsSL "$URL" -o "$DST"
          else
            wget -qO "$DST" "$URL"
          fi
          BIN_DIR="$RUNNER_TEMP/jqbin"
          mkdir -p "$BIN_DIR"
          cp "$DST" "$BIN_DIR/jq.exe"
          WIN_BIN_DIR="$(cygpath -w "$BIN_DIR")"
          echo "$WIN_BIN_DIR" >> "$GITHUB_PATH"
          "$BIN_DIR/jq.exe" --version

      - name: Verify jq (bash)
        shell: bash
        run: |
          echo "which jq => $(which jq || true)"
          jq --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build web (release)
        run: flutter build web --release
