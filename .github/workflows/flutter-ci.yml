name: Flutter CI

on:
  push:
    paths-ignore:
      - "README.md"
      - "**/*.md"
      - ".vscode/**"
  pull_request:
    paths-ignore:
      - "README.md"
      - "**/*.md"
      - ".vscode/**"
  workflow_dispatch: {}

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Lints & Analyse
    runs-on: [self-hosted, Windows, X64]
    continue-on-error: true
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4

      - name: Create .env for CI (Windows)
        shell: pwsh
        run: |
          if (-not (Test-Path .env)) {
            "SUPABASE_URL=http://localhost" | Out-File -FilePath .env -Encoding ascii
            "SUPABASE_ANON_KEY=dummy"       | Out-File -FilePath .env -Append -Encoding ascii
          }
          Write-Host "CI .env:"
          Get-Content .env

      - name: Install jq (Windows via bash)
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already present: $(jq --version)"; exit 0
          fi
          URL="https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
          DST="$RUNNER_TEMP/jq.exe"
          curl -fsSL "$URL" -o "$DST"
          BIN_DIR="$RUNNER_TEMP/jqbin"
          mkdir -p "$BIN_DIR"
          cp "$DST" "$BIN_DIR/jq.exe"
          WIN_BIN_DIR="$(cygpath -w "$BIN_DIR")"
          echo "$WIN_BIN_DIR" >> "$GITHUB_PATH"
          "$BIN_DIR/jq.exe" --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      # (Optionnel mais recommandé sur Windows runners)
      - name: Force LF line-endings for workspace
        shell: bash
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      # Vérif format (lib + test) avec longueur de ligne fixe (évite reformat aléatoire)
      - name: Format check (lib + test)
        shell: bash
        run: |
          dart format --line-length 100 --output=none --set-exit-if-changed lib test

      # Analyse non bloquante pour warnings/infos (échoue uniquement sur erreurs)
      - name: Dart analyze (lib only; no fatal warnings/infos)
        shell: bash
        run: |
          dart analyze lib --fatal-infos=false --fatal-warnings=false

  test:
    name: Tests unitaires
    runs-on: [self-hosted, Windows, X64]
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4

      - name: Create .env for CI (Windows)
        shell: pwsh
        run: |
          if (-not (Test-Path .env)) {
            "SUPABASE_URL=http://localhost" | Out-File -FilePath .env -Encoding ascii
            "SUPABASE_ANON_KEY=dummy"       | Out-File -FilePath .env -Append -Encoding ascii
          }
          Write-Host "CI .env:"
          Get-Content .env

      - name: Install jq (Windows via bash)
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already present: $(jq --version)"; exit 0
          fi
          URL="https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
          DST="$RUNNER_TEMP/jq.exe"
          curl -fsSL "$URL" -o "$DST"
          BIN_DIR="$RUNNER_TEMP/jqbin"
          mkdir -p "$BIN_DIR"
          cp "$DST" "$BIN_DIR/jq.exe"
          WIN_BIN_DIR="$(cygpath -w "$BIN_DIR")"
          echo "$WIN_BIN_DIR" >> "$GITHUB_PATH"
          "$BIN_DIR/jq.exe" --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Run tests (unit only)
        run: flutter test -r expanded --exclude-tags=e2e,integration

  build_web:
    name: Build Web (smoke compile)
    runs-on: [self-hosted, Windows, X64]
    needs: test
    defaults:
      run:
        shell: cmd
    steps:
      - uses: actions/checkout@v4

      - name: Create .env for CI (Windows)
        shell: pwsh
        run: |
          if (-not (Test-Path .env)) {
            "SUPABASE_URL=http://localhost" | Out-File -FilePath .env -Encoding ascii
            "SUPABASE_ANON_KEY=dummy"       | Out-File -FilePath .env -Append -Encoding ascii
          }
          Write-Host "CI .env:"
          Get-Content .env

      - name: Install jq (Windows via bash)
        shell: bash
        run: |
          set -euo pipefail
          if command -v jq >/dev/null 2>&1; then
            echo "jq already present: $(jq --version)"; exit 0
          fi
          URL="https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe"
          DST="$RUNNER_TEMP/jq.exe"
          curl -fsSL "$URL" -o "$DST"
          BIN_DIR="$RUNNER_TEMP/jqbin"
          mkdir -p "$BIN_DIR"
          cp "$DST" "$BIN_DIR/jq.exe"
          WIN_BIN_DIR="$(cygpath -w "$BIN_DIR")"
          echo "$WIN_BIN_DIR" >> "$GITHUB_PATH"
          "$BIN_DIR/jq.exe" --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build web (release)
        run: flutter build web --release
