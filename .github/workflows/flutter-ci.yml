name: Flutter CI

on:
  push:
    paths-ignore:
      - "README.md"
      - "**/*.md"
      - ".vscode/**"
  pull_request:
    paths-ignore:
      - "README.md"
      - "**/*.md"
      - ".vscode/**"

# Évite les runs concurrents sur la même branche/PR
concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  analyze:
    name: Lints & Analyse
    runs-on: [self-hosted, Windows, X64]
    continue-on-error: true
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      # IMPORTANT : installer jq AVANT Setup Flutter
      - name: Install jq (Windows)
        run: |
          if (Get-Command choco.exe -ErrorAction SilentlyContinue) {
            choco install jq -y --no-progress
          } else {
            $url = 'https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe'
            $dst = "$env:RUNNER_TEMP\jq.exe"
            Invoke-WebRequest $url -OutFile $dst
            $gitUsrBin = 'C:\Program Files\Git\usr\bin'
            if (-not (Test-Path $gitUsrBin)) { New-Item -ItemType Directory -Path $gitUsrBin -Force | Out-Null }
            Copy-Item $dst -Destination (Join-Path $gitUsrBin 'jq.exe') -Force
          }
          "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\Git\usr\bin"   | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "jq version:"; jq --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Flutter version
        run: flutter --version

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Format check
        run: dart format --output=none --set-exit-if-changed .

      - name: Dart analyze
        run: flutter analyze

  test:
    name: Tests unitaires
    runs-on: [self-hosted, Windows, X64]
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (Windows)
        run: |
          if (Get-Command choco.exe -ErrorAction SilentlyContinue) {
            choco install jq -y --no-progress
          } else {
            $url = 'https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe'
            $dst = "$env:RUNNER_TEMP\jq.exe"
            Invoke-WebRequest $url -OutFile $dst
            $gitUsrBin = 'C:\Program Files\Git\usr\bin'
            if (-not (Test-Path $gitUsrBin)) { New-Item -ItemType Directory -Path $gitUsrBin -Force | Out-Null }
            Copy-Item $dst -Destination (Join-Path $gitUsrBin 'jq.exe') -Force
          }
          "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\Git\usr\bin"   | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "jq version:"; jq --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Run tests (expanded)
        run: flutter test -r expanded

      # (Optionnel) Couverture
      # - name: Run tests with coverage
      #   run: flutter test --coverage
      # - name: Upload coverage artifact
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: coverage
      #     path: coverage/lcov.info

  build_web:
    name: Build Web (smoke compile)
    runs-on: [self-hosted, Windows, X64]
    needs: test
    defaults:
      run:
        shell: pwsh

    steps:
      - uses: actions/checkout@v4

      - name: Install jq (Windows)
        run: |
          if (Get-Command choco.exe -ErrorAction SilentlyContinue) {
            choco install jq -y --no-progress
          } else {
            $url = 'https://github.com/stedolan/jq/releases/download/jq-1.7.1/jq-win64.exe'
            $dst = "$env:RUNNER_TEMP\jq.exe"
            Invoke-WebRequest $url -OutFile $dst
            $gitUsrBin = 'C:\Program Files\Git\usr\bin'
            if (-not (Test-Path $gitUsrBin)) { New-Item -ItemType Directory -Path $gitUsrBin -Force | Out-Null }
            Copy-Item $dst -Destination (Join-Path $gitUsrBin 'jq.exe') -Force
          }
          "C:\ProgramData\chocolatey\bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          "C:\Program Files\Git\usr\bin"   | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "jq version:"; jq --version

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install deps
        run: flutter pub get

      - name: Generate code (build_runner)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Build web (release)
        run: flutter build web --release

      # (Optionnel) Publier l’artefact du build
      # - name: Upload web build
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: web-build
      #     path: build/web
