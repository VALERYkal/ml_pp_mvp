name: Flutter CI Nightly (Full Suite)

on:
  schedule:
    # Run every day at 02:00 UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
    # Allow manual trigger from GitHub Actions UI

jobs:
  test:
    name: Nightly full validation
    runs-on: ubuntu-latest

    steps:
      # 1) Checkout repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2) Install Java (required for Flutter on CI)
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      # 3) Install Flutter (pinned version)
      - name: Set up Flutter (pinned)
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.38.3"
          cache: true

      # 4) Verify Flutter version
      - name: Flutter doctor
        run: flutter doctor -v

      # 5) Execute D1 one-shot validation (FULL mode: all tests including integration/e2e)
      # Source of truth: scripts/d1_one_shot.sh --full
      # Enable DB integration tests with STAGING credentials via dart-defines
      - name: D1 One-Shot (full)
        env:
          SUPABASE_URL_STAGING: ${{ secrets.SUPABASE_URL_STAGING }}
          SUPABASE_ANON_KEY_STAGING: ${{ secrets.SUPABASE_ANON_KEY_STAGING }}
          TEST_USER_EMAIL_STAGING: ${{ secrets.TEST_USER_EMAIL_STAGING }}
          TEST_USER_PASSWORD_STAGING: ${{ secrets.TEST_USER_PASSWORD_STAGING }}
        run: |
          chmod +x scripts/d1_one_shot.sh
          ./scripts/d1_one_shot.sh web --full \
            --dart-define=RUN_DB_TESTS=true \
            --dart-define=SUPABASE_ENV=STAGING \
            --dart-define=SUPABASE_URL="$SUPABASE_URL_STAGING" \
            --dart-define=SUPABASE_ANON_KEY="$SUPABASE_ANON_KEY_STAGING" \
            --dart-define=TEST_USER_EMAIL="$TEST_USER_EMAIL_STAGING" \
            --dart-define=TEST_USER_PASSWORD="$TEST_USER_PASSWORD_STAGING"

      # 6) Upload CI logs (always, even on failure)
      - name: Upload CI logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ci-logs-nightly-${{ github.run_id }}
          path: .ci_logs/
          retention-days: 14
          if-no-files-found: warn
